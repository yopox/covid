<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport">
    <title>COVID 19 — Stats</title>
    <script src="stats.js"></script>
    <script src="assets/chart.bundle.min.js"></script>
    <style>
        @font-face {
            font-family: "WorkSans";
            src: url("assets/WorkSans-Regular.woff") format("woff");
        }

        @font-face {
            font-family: "WorkSansItalic";
            src: url("assets/WorkSans-Italic.woff") format("woff");
        }

        @font-face {
            font-family: "WorkSansBold";
            src: url("assets/WorkSans-SemiBold.woff") format("woff");
        }

        body {
            font-family: "WorkSans";
            padding: 64px;
            margin: 0;
            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: center;
        }

        #container {
            display: flex;
            flex-flow: row;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        h1 {
            font-family: "WorkSansBold";
            font-size: 40px;
        }

        .title {
            font-family: "WorkSansItalic";
            font-size: 32px;
            border-top: 16px;
        }

        .card {
            display: flex;
            flex-flow: column;
            justify-content: center;
            align-items: flex-start;
            margin: 16px;
            padding: 16px;
            border: 2px solid black;
            border-radius: 8px;
            box-sizing: border-box;
        }

        .subcard {
            display: flex;
            flex-flow: row;
            justify-content: center;
            padding: 16px;
        }

        .section {
            padding-top: 16px;
            font-size: 22px;
        }

        .subsection {
            padding-left: 32px;
        }

        canvas {
            margin: 16px 0;
        }

        .rowDiv {
            display: flex;
            flex-flow: row;
            justify-content: center;
            align-items: center;
        }

        input {
            margin: 8px;
        }
    </style>
</head>

<body>
    <h1>Statistiques</h1>

    <div class="card">
        <div class="title">Faux négatifs</div>
        <div class="subsection" id="faux-negatifs"></div>
    </div>

    <div class="card">
        <div class="title">Recherche par patient</div>
        <div class="rowDiv">
            Nom : <input type="text" name="nom" id="nom-recherche-patient"> <input type="button" value="Recherche"
                onclick="recherchePatient()">
        </div>
        <div class="subsection" id="resultat-recherche-patient"></div>
    </div>

    <div class="card">
        <div class="title">Recherche par médecin / infirmier·e</div>
        <div class="rowDiv">
            Nom : <input type="text" name="nom" id="nom-recherche-medecin"> <input type="button" value="Recherche"
                onclick="rechercheMedecin()">
        </div>
        <div class="subsection" id="resultat-recherche-medecin"></div>
    </div>

    <div class="card">
        <div class="title">Filtres</div>
        <div>
            <input type="checkbox" name="checkbox0" id="checkbox0">
            <label for="checkbox0">Toutes les fiches</label>
        </div>
        <div>
            <input type="checkbox" name="checkbox1" id="checkbox1">
            <label for="checkbox1">Autosurveillance à domicile sans test</label>
        </div>
        <div>
            <input type="checkbox" name="checkbox2" id="checkbox2">
            <label for="checkbox2">Test négatif</label>
        </div>
        <div>
            <input type="checkbox" name="checkbox3" id="checkbox3">
            <label for="checkbox3">Test positif</label>
        </div>
        <div>
            <input type="checkbox" name="checkbox4" id="checkbox4">
            <label for="checkbox4">Hospitalisation</label>
        </div>
        <input type="button" value="Filtrer" onclick="filtrer()">
    </div>

    <div id="container">

        <div class="card">
            <div class="title">Généralités</div>

            <div class="section">
                Taille de l'échantillon : <span id="echantillon">?</span> <br>
                Genre :
                <div class="subsection">
                    Féminin : <span id="feminin">?</span> <br>
                    Masculin : <span id="masculin">?</span> <br>
                </div>
                Moyenne d'âge :
                <div class="subsection">
                    Générale : <span id="age">?</span> <br>
                    Féminine : <span id="age-feminin">?</span> <br>
                    Masculine : <span id="age-masculin">?</span> <br>
                </div>
                Répartition :
                <div class="subsection">
                    Enfants (-18 ans) : <span id="enfants">?</span> <br>
                    Adultes (-70 ans) : <span id="adultes1">?</span> <br>
                    Adultes (+70 ans) : <span id="adultes2">?</span> <br>
                </div>
                Localisation :
                <div class="subsection" id="geo">
                </div>
                Médecin traitant :
                <div class="subsection" id="medecin">
                </div>
            </div>

        </div>

        <div class="card">
            <div class="title">Prise en charge</div>

            <div class="section">
                Date :
                <div class="subsection" id="date">
                </div>
                Consultation à :
                <div class="subsection" id="j">
                </div>
                Prise en charge :
                <div class="subsection" id="charge">
                </div>
            </div>

        </div>

        <div class="card">
            <div class="title">Noms</div>

            <div class="subsection" id="nom-resultat">
            </div>
        </div>
    </div>

</body>
<script>
    function mapProperty(property) {
        return lines => lines.map(l => l[property]).filter(x => x != undefined)
    }

    function reduceTrueFalse(lines) {
        var trueNb = lines.filter(l => l).length
        return [trueNb, lines.length - trueNb]
    }

    function reduceAverage(lines) {
        return [lines.reduce((a, b) => a + b, 0) / lines.length]
    }

    function reduceAgeCategory(lines) {
        var categories = [0, 0, 0]
        lines.forEach(age => {
            if (age < 18) {
                categories[0] += 1
            } else if (age < 70) {
                categories[1] += 1
            } else {
                categories[2] += 1
            }
        })
        return categories
    }

    function rewrite(elemID, content) {
        document.getElementById(elemID).innerHTML = content
    }

    function rewritePercentage(elemID, content, total) {
        rewrite(elemID, content + " (" + intStr(content / total * 100) + "%)")
    }

    function unique(value, index, self) {
        return self.indexOf(value) === index;
    }

    function capitalizeEachWord(str) {
        return str.replace(/\w\S*/g, function (txt) {
            return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
        })
    }

    function rewriteUniquePercentage(id, lines) {
        var rep = lines.filter(unique).map(
            x => x + " : " + lines.filter(y => y == x).length +
                " (" + intStr(lines.filter(y => y == x).length / lines.length * 100) + "%)")
        rewrite(id, rep.reduce((a, b) => a + (a != "" ? "<br>" : "") + b, ""))
    }

    function rewriteAverage(id, lines, suffix = "") {
        rewrite(id, intStr(lines.reduce((a, b) => a + b, 0) / lines.length) + suffix)
    }

    function intStr(int) {
        return int.toFixed(1)
    }


    // Setup

    selectedData = data

    function update() {
        var total = selectedData.length

        rewrite("echantillon", selectedData.length)

        var genre = reduceTrueFalse(mapProperty("femme")(selectedData))
        rewritePercentage("feminin", genre[0], total)
        rewritePercentage("masculin", genre[1], total)

        var age = mapProperty("age")(selectedData)
        rewriteAverage("age", age, " ans")
        rewriteAverage("age-feminin", mapProperty("age")(selectedData.filter(x => x["femme"])), " ans")
        rewriteAverage("age-masculin", mapProperty("age")(selectedData.filter(x => !x["femme"])), " ans")

        rewritePercentage("enfants", age.filter(a => a < 18).length, age.length)
        rewritePercentage("adultes1", age.filter(a => a >= 18 && a < 70).length, age.length)
        rewritePercentage("adultes2", age.filter(a => a >= 70).length, age.length)

        rewriteUniquePercentage("geo", mapProperty("code-postal")(selectedData).sort())

        rewriteUniquePercentage("medecin", mapProperty("medecin-traitant")(selectedData).map(mT => capitalizeEachWord(mT)).sort())

        rewriteUniquePercentage("date", mapProperty("date-consultation")(selectedData))

        rewriteUniquePercentage("j", mapProperty("j-consultation")(selectedData).sort())

        rewriteUniquePercentage("charge", mapProperty("adresse-par")(selectedData).sort())

        var nomsResultat = document.getElementById("nom-resultat")
        nomsResultat.innerHTML = "<ul>"
        selectedData.forEach(function(x) {
            nomsResultat.innerHTML += "<li>" + x["nom"] + "</li>"
        })
        nomsResultat.innerHTML += "</ul>"
    }

    // Chart utilities

    var colors = ["#169B62", "#5770BE"]
    var barColors = ["#91AE4F", "#466964", "#5770BE", "#FF8D7E"]

    var percentageOptions = {
        tooltips: {
            callbacks: {
                label: function (tooltipItem, data) {
                    var allData = data.datasets[tooltipItem.datasetIndex].data;
                    var tooltipLabel = data.labels[tooltipItem.index];
                    var tooltipData = allData[tooltipItem.index];
                    var total = 0;
                    for (var i in allData) {
                        total += allData[i];
                    }
                    var tooltipPercentage = Math.round((tooltipData / total) * 100);
                    return " " + tooltipLabel + ': ' + tooltipData + ' (' + tooltipPercentage + '%)';
                }
            }
        }
    }

    function pie(elementID, lines, mapFun, reduceFun, labels, backgroundColors) {
        new Chart(elementID, {
            type: 'pie',
            data: {
                datasets: [{
                    data: reduceFun(mapFun(lines)),
                    backgroundColor: backgroundColors
                }],
                labels: labels
            },
            options: percentageOptions
        })
    }

    function bar(elementID, lines, mapFun, reduceFun, datasetLabel, labels, backgroundColors) {
        new Chart(elementID, {
            type: 'bar',
            data: {
                datasets: [{
                    label: datasetLabel,
                    data: reduceFun(mapFun(lines)),
                    backgroundColor: backgroundColors
                }],
                labels: labels
            },
            options: percentageOptions
        })
    }

    function recherchePatient() {
        var nom = document.getElementById("nom-recherche-patient").value.toLowerCase()
        var resultat = document.getElementById("resultat-recherche-patient")
        resultat.innerHTML = "<ul>"
        data.forEach(function (line) {
            if (line["nom"].toLowerCase().includes(nom)) {
                var suivi = ""
                if (line["suivi"]["autosurveillance"]) suivi = "Autosurveillance à domicile sans test"
                if (line["suivi"]["test-covid"]) suivi = "Test non reçu"
                if (line["suivi"]["test-negatif"]) suivi = "Test négatif"
                if (line["suivi"]["test-positif"]) suivi = "Test positif"
                if (line["suivi"]["hospitalisation"]) suivi = "Autosurveillance à domicile sans test"
                resultat.innerHTML += "<li>" + line["nom"] + "<ul><li>Date : " + line["date-consultation"] + "</li><li>Heure : " + line["heure-consultation"] + "</li><li>Médecin : " + line["nom-medecin"] + "</li><li>Infirmier·e : " + line["nom-infirmier"] + "</li><li>Suivi : " + suivi + "</li></ul></li>"
            }
        })
        resultat.innerHTML += "</ul>"
    }

    function rechercheMedecin() {
        var nom = document.getElementById("nom-recherche-medecin").value.toLowerCase()
        var resultat = document.getElementById("resultat-recherche-medecin")
        resultat.innerHTML = "<ul>"
        data.forEach(function (line) {
            if (line["nom-medecin"] != undefined && line["nom-medecin"].toLowerCase().includes(nom) || line["nom-infirmier"] != undefined && line["nom-infirmier"].toLowerCase().includes(nom)) {
                var suivi = ""
                if (line["suivi"]["autosurveillance"]) suivi = "Autosurveillance à domicile sans test"
                if (line["suivi"]["test-covid"]) suivi = "Test non reçu"
                if (line["suivi"]["test-negatif"]) suivi = "Test négatif"
                if (line["suivi"]["test-positif"]) suivi = "Test positif"
                if (line["suivi"]["hospitalisation"]) suivi = "Autosurveillance à domicile sans test"
                resultat.innerHTML += "<li>" + line["nom"] + "<ul><li>Date : " + line["date-consultation"] + "</li><li>Heure : " + line["heure-consultation"] + "</li><li>Médecin : " + line["nom-medecin"] + "</li><li>Infirmier·e : " + line["nom-infirmier"] + "</li><li>Suivi : " + suivi + "</li></ul></li>"
            }
        })
        resultat.innerHTML += "</ul>"
    }

    function filtrer() {
        if (document.getElementById("checkbox0").checked) {
            selectedData = data
            update()
            return 1
        }
        var c1 = document.getElementById("checkbox1").checked
        var c2 = document.getElementById("checkbox2").checked
        var c3 = document.getElementById("checkbox3").checked
        var c4 = document.getElementById("checkbox4").checked
        selectedData = data.filter(function(x) {
            var selected = false
            if (c1) {
                selected = selected || x["suivi"]["autosurveillance"]
            }
            if (c2) {
                selected = selected || x["suivi"]["test-negatif"]
            }
            if (c3) {
                selected = selected || x["suivi"]["test-positif"]
            }
            if (c4) {
                selected = selected || x["suivi"]["hospitalisation"]
            }
            return selected
        })
        update()

        var fauxNegatifs = document.getElementById("faux-negatifs")
        fauxNegatifs.innerHTML = "<ul>"
        data.forEach(function(x) {
            return !x["suivi"]["test-positif"] && x["diagnostic"]
        })
        fauxNegatifs.innerHTML += "</ul>"

    }

    update()
</script>

</html>